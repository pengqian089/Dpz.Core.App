@using Dpz.Core.App.Client.Services
@inherits LayoutComponentBase
@inject LayoutService LayoutService

@* MudBlazor 必需的提供程序 *@
<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="app-container">
    <div class="app-content">
        @Body
    </div>
    
    @if (LayoutService.IsNavbarVisible)
    {
        <NavMenu />
    }
</div>

@code {
    private bool _isDarkMode;
    private MudThemeProvider? _mudThemeProvider;

    protected override void OnInitialized()
    {
        LayoutService.OnNavbarVisibilityChanged += OnLayoutChanged;
    }

    private void OnLayoutChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isDarkMode = (await _mudThemeProvider?.GetSystemDarkModeAsync()!) == true;
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    public void Dispose()
    {
        LayoutService.OnNavbarVisibilityChanged -= OnLayoutChanged;
    }
}
