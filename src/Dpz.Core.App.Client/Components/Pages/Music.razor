@page "/music"

<MudStack Class="music-page" Spacing="2">
    <MudPaper Class="top-bar pa-3" Elevation="1" Square="true">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" OnClick="NavigateBack" />
                <MudText Typo="Typo.h6" Class="page-title">音乐播放器</MudText>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                @if (_isBuffering)
                {
                    <MudProgressCircular Indeterminate Color="Color.Primary" Size="Size.Small" />
                }
                <MudIconButton Icon="@Icons.Material.Filled.PlaylistPlay" Color="Color.Primary" OnClick="TogglePlaylist" />
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (_loading)
    {
        <MudStack Spacing="2" Class="pa-3 skeleton-wrapper">
            <MudSkeleton Width="100%" Height="48vh" Class="mb-2" />
            <MudSkeleton Width="60%" Height="24px" Class="mb-1" />
            <MudSkeleton Width="40%" Height="18px" Class="mb-3" />
            <MudSkeleton Width="100%" Height="8px" Class="mb-2" />
            <MudSkeleton Width="100%" Height="52px" />
        </MudStack>
    }
    else if (Current == null)
    {
        <MudPaper Class="empty-block pa-6" Elevation="0">
            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.LibraryMusic" Color="Color.Tertiary" Size="Size.Large" />
                <MudText Typo="Typo.subtitle1">暂无音乐</MudText>
                <MudText Typo="Typo.caption" Color="Color.Tertiary">请稍后再试</MudText>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <div class="player-screen">
            <div class="upper-area">
                <div class="cover-wrapper">
                    @if (!string.IsNullOrWhiteSpace(Current.CoverUrl))
                    {
                        <img src="@Current.CoverUrl" alt="封面" class="cover-img" loading="lazy" />
                    }
                    else
                    {
                        <div class="cover-fallback">
                            <MudIcon Icon="@Icons.Material.Filled.MusicNote" Size="Size.Large" />
                        </div>
                    }
                    <div class="cover-overlay"></div>
                    <div class="floating-meta">
                        <MudText Typo="Typo.subtitle1" Class="title truncate-1">@Current.Title</MudText>
                        <MudText Typo="Typo.caption" Class="artist truncate-1" Color="Color.Tertiary">@Current.Artist</MudText>
                    </div>
                </div>
                @if (_showLyrics && _currentLyricLines.Count > 0)
                {
                    <MudPaper Class="lyrics-panel" Elevation="0">
                        <div id="lyrics-scroll" class="lyrics-scroll">
                            @for (int i = 0; i < _currentLyricLines.Count; i++)
                            {
                                var line = _currentLyricLines[i];
                                var active = i == _activeLyricIndex && !string.IsNullOrEmpty(line.Text);
                                <div id="lyric-@i" class="lyric-line @(active ? "active" : "")">@line.Text</div>
                            }
                        </div>
                    </MudPaper>
                }
            </div>
            <div class="lower-area pa-3">
                <MudStack Spacing="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="time-row">
                        <MudText Typo="Typo.caption">@_elapsedText</MudText>
                        <MudText Typo="Typo.caption">@_durationText</MudText>
                    </MudStack>
                    <MudSlider @bind-Value="_progressSeconds" Min="0" Max="@_durationSeconds" Step="1" Disabled="_durationSeconds <= 0" Color="Color.Primary" OnChange="OnSeek" Class="progress-slider" />
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Elevation="0" Dense="true" Variant="Variant.Outlined">@_errorMessage <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small" OnClick="RetryAsync">@($"重试({_retryCount}/{MaxRetry})")</MudButton></MudAlert>
                    }
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceAround" Class="controls-bar mt-2">
                        <MudIconButton Icon="@Icons.Material.Filled.SkipPrevious" Color="Color.Primary" Disabled="_musics.Count == 0" OnClick="PlayPreviousAsync" />
                        <MudIconButton Icon="@( _isPlaying ? Icons.Material.Filled.PauseCircleFilled : Icons.Material.Filled.PlayCircleFilled)" Color="Color.Primary" Size="Size.Large" OnClick="TogglePlayAsync" Disabled="_isBuffering" />
                        <MudIconButton Icon="@Icons.Material.Filled.SkipNext" Color="Color.Primary" Disabled="_musics.Count == 0" OnClick="PlayNextAsync" />
                        <MudIconButton Icon="@GetModeIcon()" Color="Color.Primary" OnClick="ToggleMode" />
                        <MudIconButton Icon="@(_showLyrics ? Icons.Material.Filled.Subtitles : Icons.Material.Filled.SubtitlesOff)" Color="Color.Primary" OnClick="ToggleLyrics" />
                    </MudStack>
                </MudStack>
            </div>
        </div>

        @if (_showPlaylist)
        {
            <MudPaper Class="playlist-panel pa-2" Elevation="1">
                <MudStack Spacing="1">
                    @for (int i = 0; i < _musics.Count; i++)
                    {
                        var m = _musics[i];
                        <MudPaper Class="@GetPlaylistCss(i)" Elevation="0" @onclick="(()=>PlayIndexAsync(i))">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="pa-2">
                                <MudText Typo="Typo.caption" Class="index">@(i+1)</MudText>
                                <MudStack Spacing="0" Style="flex:1;">
                                    <MudText Typo="Typo.body2" Class="truncate-1">@m.Title</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Tertiary" Class="truncate-1">@m.Artist</MudText>
                                </MudStack>
                                @if (i==_currentIndex && _isPlaying)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.GraphicEq" Color="Color.Primary" />
                                }
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            </MudPaper>
        }
    }
</MudStack> @* end root stack *@